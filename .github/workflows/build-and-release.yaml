name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
    branches: 
      - main


permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Podman & yq
        run: |
          sudo apt-get update
          sudo apt-get install -y podman curl
          curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Create output directory
        run: mkdir -p output

      - name: Parse build order
        id: config
        run: |
          ORDER=$(yq e '.build-order | join(",")' config.yaml)
          echo "order=$ORDER" >> "$GITHUB_OUTPUT"

      - name: Build containers and extract executables
        run: |
          IFS=',' read -ra ORDER <<< "${{ steps.config.outputs.order }}"

          for PACKAGE in "${ORDER[@]}"; do
            echo "ðŸ”¨ Building: $PACKAGE"
            bash scripts/build.sh "$PACKAGE"

            echo "ðŸ“¦ Extracting executables for: $PACKAGE"
            EXECUTABLES=$(yq e ".executables.\"$PACKAGE\"[]" config.yaml || true)
            if [[ -z "$EXECUTABLES" ]]; then
              echo "âš ï¸  No executables defined for $PACKAGE, skipping extract"
              continue
            fi

            CID=$(podman create "hypr-builder:${PACKAGE}-latest")
            for BIN_PATH in $EXECUTABLES; do
              FILE_NAME=$(basename "$BIN_PATH")
              podman cp "$CID:$BIN_PATH" "output/${PACKAGE}-$FILE_NAME"
            done
            podman rm "$CID"
          done

      - name: Create tarball
        run: |
          tar -czf hypr-artifacts.tar.gz -C output .

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: hypr-artifacts.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

