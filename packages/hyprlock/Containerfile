FROM hypr-builder:aquamarine-latest as aquamarine
FROM hypr-builder:hyprlang-latest as hyprlang
FROM hypr-builder:hyprcursor-latest as hyprcursor
FROM hypr-builder:hyprwayland-scanner-latest as hyprwayland-scanner
FROM hypr-builder:hyprutils-latest as hyprutils
FROM hypr-builder:hyprgraphics-latest as hyprgraphics

FROM hypr-builder:base-latest as BUILDER

COPY --from=aquamarine /opt/aquamarine /opt/aquamarine
COPY --from=hyprlang /opt/hyprlang /opt/hyprlang
COPY --from=hyprcursor /opt/hyprcursor /opt/hyprcursor
COPY --from=hyprwayland-scanner /opt/hyprwayland-scanner /opt/hyprwayland-scanner
COPY --from=hyprutils /opt/hyprutils /opt/hyprutils
COPY --from=hyprgraphics /opt/hyprgraphics /opt/hyprgraphics

ENV PATH="/opt/hyprgraphics/bin:/opt/hyprutils/bin:/opt/hyprwayland-scanner/bin:/opt/hyprcursor/bin:/opt/hyprlang/bin:/opt/aquamarine/bin:${PATH}"
ENV LD_LIBRARY_PATH="/opt/hyprgraphics/lib:/opt/hyprutils/lib:/opt/hyprwayland-scanner/lib:/opt/hyprcursor/lib:/opt/hyprlang/lib:/opt/aquamarine/lib:${LD_LIBRARY_PATH}"
ENV CMAKE_PREFIX_PATH="/opt/hyprgraphics:/opt/hyprutils:/opt/hyprwayland-scanner:/opt/hyprcursor:/opt/hyprlang:/opt/aquamarine:${CMAKE_PREFIX_PATH}"
ENV PKG_CONFIG_PATH="/opt/hyprgraphics/lib/pkgconfig:/opt/hyprutils/lib/pkgconfig:/opt/hyprwayland-scanner/lib/pkgconfig:/opt/hyprcursor/lib/pkgconfig:/opt/hyprlang/lib/pkgconfig:/opt/aquamarine/lib/pkgconfig:${PKG_CONFIG_PATH}"

RUN echo "/opt/aquamarine/lib" > /etc/ld.so.conf.d/aquamarine.conf && \
    echo "/opt/hyprcursor/lib" > /etc/ld.so.conf.d/hyprcursor.conf && \
    echo "/opt/hyprcursor/lib" > /etc/ld.so.conf.d/hyprcursor.conf && \
    echo "/opt/hyprutils/lib" > /etc/ld.so.conf.d/hyprutils.conf && \
    echo "/opt/hyprwayland-scanner/lib" > /etc/ld.so.conf.d/hyprwayland-scanner.conf && \
    ldconfig


ARG DEPENDENCY=hyprlock

RUN git clone --recursive https://github.com/hyprwm/${DEPENDENCY}.git  

WORKDIR /hypr/${DEPENDENCY}

RUN git checkout v0.4.1

RUN wget https://gitlab.freedesktop.org/libinput/libinput/-/archive/1.26.0/libinput-1.26.0.tar.gz && \
    tar -xzf libinput-1.26.0.tar.gz && \
    cd libinput-1.26.0 && \
    meson setup build --prefix=/usr --buildtype=release -Dtests=false && \
    ninja -C build && \
    ninja -C build install && \
    ldconfig

RUN cmake --no-warn-unused-cli -DCMAKE_BUILD_TYPE:STRING=Release -S . -B ./build && \
    cmake --build ./build --config Release --target hyprlock -j`nproc 2>/dev/null || getconf _NPROCESSORS_CONF`
